name: "Build and Release (Cron)"

on:
  schedule:
    - cron: "37 1 * * *"
  workflow_dispatch:

jobs:
  get-tags:
    runs-on: ubuntu-latest
    outputs:
      kernel-tags: ${{ steps.tags.outputs.kernel-tags }}
      zfs-tags: ${{ steps.tags.outputs.zfs-tags }}
    steps:
      - name: Fetch latest tags
        id: tags
        run: |
          # Fetch latest kernel tags
          KERNEL_TAGS=$(curl -s https://api.github.com/repos/microsoft/WSL2-Linux-Kernel/releases \
            | jq -r '[.[] | select(.prerelease == false)][0:1] | map(.tag_name) | @json')
          echo "kernel-tags=$KERNEL_TAGS" >> $GITHUB_OUTPUT

          # Fetch latest ZFS tags
          ZFS_TAGS=$(curl -s https://api.github.com/repos/openzfs/zfs/releases \
            | jq -r '[.[] | select(.prerelease == false)][0:1] | map(.tag_name) | @json')
          echo "zfs-tags=$ZFS_TAGS" >> $GITHUB_OUTPUT

  build-and-release:
    needs: get-tags
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kernel-tag: ${{ fromJson(needs.get-tags.outputs.kernel-tags) }}
        zfs-tag: ${{ fromJson(needs.get-tags.outputs.zfs-tags) }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5
      - uses: cachix/install-nix-action@v31
      - name: Build and release
        run: |
          RELEASE_TAG="${{ matrix.zfs-tag }}-${{ matrix.kernel-tag }}"

          if ! gh release view "$RELEASE_TAG" > /dev/null 2>&1; then
            echo "Building ZFS module for $RELEASE_TAG"
            nix develop --ignore-environment --command bash build.sh "${{ matrix.kernel-tag }}" "${{ matrix.zfs-tag }}"

            echo "Creating release: $RELEASE_TAG"
            gh release create "$RELEASE_TAG" \
              ".tmp/result/zfs.ko" \
              --title "ZFS ${{ matrix.zfs-tag }} - Kernel ${{ matrix.kernel-tag }}" \
              --generate-notes
          else
            echo "Release $RELEASE_TAG already exists, skipping"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
